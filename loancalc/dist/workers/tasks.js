"use strict";var _this=this,__awaiter=this&&this.__awaiter||function(a,b,c,d){return new(c||(c=Promise))(function(e,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d["throw"](a))}catch(a){f(a)}}function i(a){a.done?e(a.value):new c(function(b){b(a.value)}).then(g,h)}i((d=d.apply(a,b||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const serve_1=require("../serve"),app_queue_1=require("./app-queue"),nodemailer=require("nodemailer");class Tasks{constructor(){this.registered=new Map}register(a,b){this.registered.set(a,b)}pass(a,b){return __awaiter(this,void 0,void 0,function*(){const c=this.registered.get(a);return c?yield c(b):null})}}exports.Tasks=Tasks;const tasks=new Tasks,emailTransporter=nodemailer.createTransport({},{from:"\"FinCalc\" <noreply@fincalc.co>"});tasks.register("email",(a)=>__awaiter(_this,void 0,void 0,function*(){const b={to:a.to,subject:a.subject,text:a.content,html:a.content};try{return yield emailTransporter.sendMail(b),!0}catch(a){serve_1.Logger.error("Error sending email: ",a)}return!1}));function retryMessage(a,b){return __awaiter(this,void 0,void 0,function*(){if(b.retries&&b.currentTry<b.retries){const c=b.currentTry?b.currentTry+1:1,d=app_queue_1.createTask(b.type,b.payload,c);d.retry(b.retries),yield a.send(d),serve_1.Logger.info(`Retrying ${b.type} message (${c} / ${b.retries}).`)}})}function _initTasks(){return __awaiter(this,void 0,void 0,function*(){const a=yield app_queue_1.createQueueProducer(),b=yield app_queue_1.createQueueConsumer();b.consume((b)=>__awaiter(this,void 0,void 0,function*(){let c=null;try{c=yield tasks.pass(b.type,b.payload),"boolean"!=typeof c||c||(yield retryMessage(a,b))}catch(c){yield retryMessage(a,b)}}))})}exports._initTasks=_initTasks;function initTasks(){_initTasks().then(()=>{serve_1.Logger.info("Initialized task consumer.")},(a)=>{serve_1.Logger.error("Error initializing task consumer: ",a)})}exports.initTasks=initTasks;