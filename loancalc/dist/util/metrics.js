"use strict";var __awaiter=this&&this.__awaiter||function(a,b,c,d){return new(c||(c=Promise))(function(e,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d["throw"](a))}catch(a){f(a)}}function i(a){a.done?e(a.value):new c(function(b){b(a.value)}).then(g,h)}i((d=d.apply(a,b||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const serve_1=require("../serve"),models_1=require("../graph/calculators/models"),uuidv4=require("uuid/v4"),crypto=require("crypto"),moment=require("moment"),models_2=require("../graph/leads/models"),Faker=require("faker"),ENGAGEMENT_CHANCE=70,CONVERSION_CHANCE=10;function percentChance(a){return Math.random()<a/100}function randInt(a,b){return Math.round(a+Math.random()*(b-a))}function randIp(){return`${randInt(0,255)}.${randInt(0,255)}.${randInt(0,255)}.${randInt(0,255)}`}function randIDString(a=16){return crypto.randomBytes(0|a/2).toString("hex")}function createRandomVisits(a,b,c,d){return __awaiter(this,void 0,void 0,function*(){const e=new models_1.Calculators;let f;if(f=yield e.getByShortId(b),null==f)throw new Error("No calculator with given identifier.");else yield createRandomVisitsForCalculator(a,f,c,d)})}exports.createRandomVisits=createRandomVisits;function calculateLoanPayment(a,b,c){return 0<b?b*a/(1-1/Math.pow(1+b,c)):a/c}exports.calculateLoanPayment=calculateLoanPayment;function createRandomVisitsForCalculator(a,b,c,d){return __awaiter(this,void 0,void 0,function*(){let e=0,f=0,g=0,h=[];const i=c.toDate().getTime(),j=d.toDate().getTime();for(let c=0;c<a;c++){e++;const a=MetricsSession.random(b.uuid,b.client_uuid);h.length=0;const c=moment(randInt(i,j));h.push(Metrics.pushEventAt(a,Metrics.VISIT_EVENT,c));const d=percentChance(ENGAGEMENT_CHANCE),k=percentChance(CONVERSION_CHANCE);if((d||k)&&(h.push(Metrics.pushEventAt(a,Metrics.ENGAGEMENT_EVENT,c)),f++),k){const b=Faker.random.number({min:5e3,max:6e4,precision:1}),d=Faker.random.number({min:0,max:b/2,precision:2}),e=Faker.random.number({min:0.1,max:4,precision:0.05}),f=Faker.random.arrayElement([36,60,72,84]),i=calculateLoanPayment(b-d,e/100/12,f),j={calculator_uuid:a.calculatorUUID,client_uuid:a.clientUUID,email_address:Faker.internet.email(),first_name:Faker.name.firstName(),last_name:Faker.name.lastName(),metadata:{loanAmount:b,downPayment:d,interestRate:e,termLength:f,monthlyPayment:i,loanType:"auto-loan"},phone_number:Faker.phone.phoneNumber(),session_uuid:a.sessionId,visitor_uuid:a.visitorId},k=new models_2.Leads;h.push(k.createLeadAt(j,c)),h.push(Metrics.pushEventAt(a,Metrics.CONVERSION_EVENT,c)),g++}yield Promise.all(h)}serve_1.Logger.info("Generated random visits. [%d visits] [%d engagements] [%d conversions]",e,f,g)})}function isUUIDContainer(a){return a&&"object"==typeof a&&"string"==typeof a.uuid}function isShortIdContainer(a){return a&&"object"==typeof a&&"string"==typeof a.shortid}class MetricsSession{constructor(a,b,c,d,e){this.sessionId=a,this.visitorId=b,this.calculatorUUID=c,this.clientUUID=d,this.info=e}static random(a,b){return new MetricsSession(uuidv4(),uuidv4(),a,b,{ipAddress:randIp(),facebookId:randIDString(16),googleId:randIDString(16)})}static fromContext(a,b,c){return __awaiter(this,void 0,void 0,function*(){let d,e;if(isShortIdContainer(a)){const b=yield serve_1.db.one(`
                SELECT uuid, client_uuid FROM calculators
                WHERE shortid = $1;
            `,a.shortid);d=b.uuid,e=b.client_uuid}else if(isUUIDContainer(a)){const b=yield serve_1.db.one(`
                SELECT client_uuid FROM calculators
                WHERE uuid = $1;
            `,a.uuid);d=a.uuid,e=b.client_uuid}else d=a.uuid,e=a.client_uuid;let f=b.cookies.get("mts:sid",{signed:!0}),g=b.cookies.get("mts:vid",{signed:!0});g||(g=uuidv4(),serve_1.Logger.debug("setting visitor cookie to: ",g),b.cookies.set("mts:vid",g,{httpOnly:!0,signed:!0,maxAge:2592000000,overwrite:!0}),f=null),f||(f=uuidv4(),b.cookies.set("mts:sid",f,{httpOnly:!0,signed:!0,maxAge:void 0,overwrite:!0}));const h=b.ips&&0<b.ips.length?b.ips[0]:void 0,i=b.get("Referer")||void 0;let j={ipAddress:h,referrer:i};return c&&(j=Object.assign(j,c)),new MetricsSession(f,g,d,e,j)})}}exports.MetricsSession=MetricsSession;class Metrics{static pushEvent(a,b){return __awaiter(this,void 0,void 0,function*(){const c={visitor_uuid:a.visitorId,session_uuid:a.sessionId,calculator_uuid:a.calculatorUUID,client_uuid:a.clientUUID,event_type:b,payload:JSON.stringify(a.info)};yield serve_1.db.one(`
            SELECT * FROM push_calc_event($<visitor_uuid>, $<session_uuid>, $<calculator_uuid>, $<client_uuid>, $<event_type>, $<payload>)
        `,c)})}static pushEventAt(a,b,c){return __awaiter(this,void 0,void 0,function*(){const d={visitor_uuid:a.visitorId,session_uuid:a.sessionId,calculator_uuid:a.calculatorUUID,client_uuid:a.clientUUID,event_type:b,payload:JSON.stringify(a.info),created:c.format()};yield serve_1.db.one(`SELECT * FROM push_calc_event_at($<visitor_uuid>, $<session_uuid>, $<calculator_uuid>, $<client_uuid>, $<event_type>, $<payload>, $<created>)`,d)})}static getEventCountsForDays(){return __awaiter(this,void 0,void 0,function*(){})}}Metrics.VISIT_EVENT="visit",Metrics.ENGAGEMENT_EVENT="engagement",Metrics.CONVERSION_EVENT="conversion",exports.Metrics=Metrics;class CalcEventInput{}exports.CalcEventInput=CalcEventInput;