"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const pg=require("pg"),logger_1=require("./logger"),config={user:"dev",password:"development",host:"localhost",port:5432,max:10,idleTimeoutMillis:3e3},pool=new pg.Pool(config);pool.on("error",function(a){logger_1.default.error("[DB] Idle Client Error",a.message,a.stack)});const QUERY_REPLACE_REGEX=/\$(?:([a-zA-Z0-9]+)|(?:\{([a-zA-Z0-9]+)(?:\:([a-zA-Z0-9]+))?\}))/g;function createQueryString(a,b){if(b&&!Array.isArray(b)){QUERY_REPLACE_REGEX.lastIndex=0;let c=[],d=0;a=a.replace(QUERY_REPLACE_REGEX,(a,e,f,g)=>{return void 0===e?(c.push(b[f]),d++,void 0===g?`$${d}`:`$${d}::${g}`):(c.push(b[e]),d++,`$${d}`)}),b=c}return{text:a,values:b}}exports.createQueryString=createQueryString;function query(a,b){let{text:c,values:d}=createQueryString(a,b);return new Promise((a,b)=>{pool.query(c,d,(c,d)=>{c?b(c):a(d)})})}exports.query=query;function queryClient(a,b,c){let{text:d,values:e}=createQueryString(b,c);return new Promise((b,c)=>{a.query(d,e,(a,d)=>{a?c(a):b(d)})})}exports.queryClient=queryClient;function transaction(a){return new Promise((b,c)=>{pool.connect((d,e,f)=>{a(d,(a,b,c)=>{return queryClient(e,a,b,c)},e).then(()=>{f(),b()},(a)=>{c(a)})})})}exports.transaction=transaction;